<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <script src="opensheetmusicdisplay.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background-color: #FFFFFF;
            overflow-x: auto;
        }
        #osmdCanvas {
            width: 800px;
            min-width: 800px;
            position: relative; /* ì¤‘ìš”: ìì‹ ìš”ì†Œì˜ absolute ê¸°ì¤€ì  */
        }
        .highlighted-measure {
            fill: rgba(0, 122, 255, 0.3) !important;
        }
        
        /* â­ï¸ í”„ë¡œí•„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .profile-button {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #00a8cc);
            border: 3px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
            transition: transform 0.2s;
        }
        
        .profile-button:hover {
            transform: scale(1.1);
        }
        
        .profile-button::before {
            content: "";
            font-size: 20px;
            color: white;
        }
    </style>
</head>
<body>
    <div id="osmdCanvas"></div>

    <script>
        var osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdCanvas", {
            autoResize: false,
            backend: "svg",
            drawTitle: true,
            drawComposer: true,
            drawSubtitle: false,
            drawLyricist: false,
            drawPartNames: true,
            pageFormat: "Endless",
            pageBackgroundColor: "#FFFFFF",
        });
        
        osmd.load("BrahWiMeSample.musicxml")
            .then(function() {
                osmd.setOptions({ autoResize: false });
                osmd.render();
                console.log('âœ… OSMD ë Œë”ë§ ì™„ë£Œ');
                
                setTimeout(function() {
                    setupMeasureClickEvents();
                    addProfileButtons(); // â­ï¸ í”„ë¡œí•„ ë²„íŠ¼ ì¶”ê°€
                }, 500);
            })
            .catch(function(error) {
                console.error('âŒ OSMD ë¡œë”© ì—ëŸ¬:', error);
            });

        // â­ï¸ íŠ¹ì • ë§ˆë””ì— í”„ë¡œí•„ ë²„íŠ¼ ì¶”ê°€
        function addProfileButtons() {
            // ë²„íŠ¼ì„ ì¶”ê°€í•  ë§ˆë”” ë²ˆí˜¸ë“¤ (1ë²ˆ, 5ë²ˆ, 9ë²ˆ ë§ˆë””)
            const measureNumbers = [1, 5, 9];
            
            let measures = document.querySelectorAll('svg rect');
            if (measures.length === 0) {
                measures = document.querySelectorAll('[class*="measure"]');
            }
            
            console.log('ğŸ”˜ í”„ë¡œí•„ ë²„íŠ¼ ì¶”ê°€ ì‹œì‘, ì „ì²´ ë§ˆë””:', measures.length);
            
            const container = document.getElementById('osmdCanvas');
            
            measureNumbers.forEach(measureNum => {
                if (measureNum <= measures.length) {
                    const measureElement = measures[measureNum - 1];
                    
                    try {
                        const rect = measureElement.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();
                        
                        // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œ
                        const x = rect.left - containerRect.left + (rect.width / 2) - 20; // ì¤‘ì•™ì—ì„œ -20px (ë²„íŠ¼ ë°˜ì§€ë¦„)
                        const y = rect.top - containerRect.top - 50; // ë§ˆë”” ìœ„ 50px
                        
                        // HTML ë²„íŠ¼ ìƒì„±
                        const button = document.createElement('div');
                        button.className = 'profile-button';
                        button.style.left = x + 'px';
                        button.style.top = y + 'px';
                        button.dataset.measureNumber = measureNum;
                        
                        // í´ë¦­ ì´ë²¤íŠ¸
                        button.addEventListener('click', function() {
                            console.log('ğŸ‘¤ í”„ë¡œí•„ ë²„íŠ¼ í´ë¦­:', measureNum);
                            
                            // Swiftë¡œ ë©”ì‹œì§€ ì „ì†¡
                            if (window.webkit && window.webkit.messageHandlers.profileButtonClicked) {
                                window.webkit.messageHandlers.profileButtonClicked.postMessage({
                                    measureNumber: measureNum
                                });
                            }
                        });
                        
                        container.appendChild(button);
                        console.log('âœ… í”„ë¡œí•„ ë²„íŠ¼ ì¶”ê°€:', measureNum + 'ë²ˆ ë§ˆë””, ìœ„ì¹˜:', x, y);
                        
                    } catch (e) {
                        console.error('ë²„íŠ¼ ì¶”ê°€ ì—ëŸ¬:', e);
                    }
                }
            });
        }

        function setupMeasureClickEvents() {
            console.log('ğŸ” ë§ˆë”” í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì • ì‹œì‘');
            
            let measures = [];
            
            measures = document.querySelectorAll('.vexflow-measure');
            console.log('ë°©ë²•1 (vexflow-measure):', measures.length);
            
            if (measures.length === 0) {
                measures = document.querySelectorAll('[class*="measure"]');
                console.log('ë°©ë²•2 ([class*="measure"]):', measures.length);
            }
            
            if (measures.length === 0) {
                measures = document.querySelectorAll('svg g[class*="StaffEntry"]');
                console.log('ë°©ë²•3 (SVG g StaffEntry):', measures.length);
            }
            
            if (measures.length === 0) {
                measures = document.querySelectorAll('svg rect');
                console.log('ë°©ë²•4 (ëª¨ë“  rect):', measures.length);
            }
            
            console.log('âœ… ìµœì¢… ì°¾ì€ ë§ˆë”” ê°œìˆ˜:', measures.length);
            
            if (measures.length === 0) {
                console.warn('âš ï¸ ë§ˆë””ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            measures.forEach((measureElement, index) => {
                measureElement.style.cursor = 'pointer';
                
                measureElement.addEventListener('click', function(e) {
                    console.log('ğŸµ ë§ˆë”” í´ë¦­ë¨:', index + 1);
                    
                    document.querySelectorAll('.highlight-rect').forEach(r => r.remove());
                    
                    measures.forEach(m => {
                        m.style.fill = '';
                        m.style.opacity = '';
                        m.classList.remove('highlighted-measure');
                    });
                    
                    measureElement.style.fill = 'rgba(0, 122, 255, 0.3)';
                    measureElement.classList.add('highlighted-measure');
                    
                    if (measureElement.tagName.toLowerCase() === 'g') {
                        try {
                            const bbox = measureElement.getBBox();
                            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                            rect.setAttribute('x', bbox.x);
                            rect.setAttribute('y', bbox.y);
                            rect.setAttribute('width', bbox.width);
                            rect.setAttribute('height', bbox.height);
                            rect.setAttribute('fill', 'rgba(0, 122, 255, 0.3)');
                            rect.setAttribute('class', 'highlight-rect');
                            rect.style.pointerEvents = 'none';
                            measureElement.insertBefore(rect, measureElement.firstChild);
                        } catch (e) {
                            console.log('bbox ì—ëŸ¬:', e);
                        }
                    }
                    
                    if (window.webkit && window.webkit.messageHandlers.measureClicked) {
                        window.webkit.messageHandlers.measureClicked.postMessage({
                            measureNumber: index + 1
                        });
                    }
                });
            });
        }
    </script>
</body>
</html>
